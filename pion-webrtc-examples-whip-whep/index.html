<html>

  <!--
		SPDX-FileCopyrightText: 2023 The Pion community <https://pion.ly>
		SPDX-License-Identifier: MIT
	-->
  <head>
    <title>whip-whep</title>
    <link rel="stylesheet" href="reset.css">
    <style>
        .container {
          padding: 16px;
        }
        button {
          min-width: 120px;
          min-height: 36px;
        }
        h3 {
          margin-top: 12px;
        }
        video {
          width: 800;
          min-height: 400;
          max-height: 600;
        }
    </style>
  </head>

  <body>
    <div class="container">
      <button onclick="window.doWHIP()">Publish</button>
      <button onclick="window.doWHEP()">Subscribe</button>

      <h3>Video</h3>
      <video id="videoPlayer" autoplay muted controls> </video>

      <h3>ICE Connection States</h3>
      <div id="iceConnectionStates"></div>
    </div>
  </body>

  <script>
    let peerConnection

    function resetPeerConnection() {
      let elStates = document.getElementById('iceConnectionStates');
      elStates.innerHTML = ''

      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }

      peerConnection = new RTCPeerConnection();

      peerConnection.oniceconnectionstatechange = () => {
        let el = document.createElement('p')
        el.appendChild(document.createTextNode(peerConnection.iceConnectionState))

        elStates.appendChild(el);
      }
    }

    window.doWHEP = () => {
      resetPeerConnection();

      peerConnection.addTransceiver('video', { direction: 'recvonly' })
      peerConnection.addTransceiver('audio', { direction: 'recvonly' })

      peerConnection.ontrack = function (event) {
        document.getElementById('videoPlayer').srcObject = event.streams[0]
      }

      peerConnection.createOffer().then(offer => {
        peerConnection.setLocalDescription(offer)

        fetch(`/whep`, {
          method: 'POST',
          body: offer.sdp,
          headers: {
            'Authorization': 'Bearer none',
            'Content-Type': 'application/sdp'
          }
        }).then(r => r.text())
          .then(answer => {
            peerConnection.setRemoteDescription({
              sdp: answer,
              type: 'answer'
            })
          })
      })
    }

    window.doWHIP = () => {
      resetPeerConnection();

      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
          document.getElementById('videoPlayer').srcObject = stream
          stream.getTracks().forEach(track => peerConnection.addTrack(track, stream))

          peerConnection.createOffer().then(offer => {
            peerConnection.setLocalDescription(offer)

            fetch(`/whip`, {
              method: 'POST',
              body: offer.sdp,
              headers: {
                'Authorization': 'Bearer none',
                'Content-Type': 'application/sdp'
              }
            }).then(r => r.text())
              .then(answer => {
                peerConnection.setRemoteDescription({
                  sdp: answer,
                  type: 'answer'
                })
              })
          })
      })
    }
  </script>
</html>
