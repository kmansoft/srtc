<html>

  <!--
		SPDX-FileCopyrightText: 2023 The Pion community <https://pion.ly>
		SPDX-License-Identifier: MIT
	-->
  <head>
    <title>whip-whep</title>
    <link rel="stylesheet" href="reset.css">
    <style>
        .container {
          padding: 16px;
        }
        button {
          min-width: 120px;
          min-height: 36px;
        }
        h3 {
          margin-top: 12px;
        }
        video {
          width: 800;
          height: 600;
        }

      .row {
          display: flex;
          flex-wrap: wrap;
          gap: 20px;
      }
      .cell {
          flex: 1 1 200px;
      }

      pre {
        min-width: 200px;
      }

    </style>
  </head>

  <body>
    <div class="container">
      <button onclick="window.doWHIP()">Publish</button>
      <button onclick="window.doWHEP()">Subscribe</button>

      <div class="row">
        <div class="cell">
          <h3>Video</h3>
          <video id="videoPlayer" autoplay muted controls> </video>
        </div>

        <div class="cell">
          <h3>Logging</h3>
          <pre id="messageLog"></pre>
        </div>
      </div>
    </div>
  </body>

  <script>
    const elMessageLog = document.getElementById('messageLog');
    let peerConnection

    function printToLog(message) {
      const el = document.createTextNode(message + "\n")
      elMessageLog.appendChild(el)
    }

    async function getVideoCodec(peerConnection) {
      const stats = await peerConnection.getStats();
      
      for (const [id, stat] of stats) {
        // Look for outbound video streams
        if (stat.type === 'outbound-rtp' && stat.kind === 'video') {
          console.log('Outbound video codec:', stat.codecId);

          // Get detailed codec info
          const codecStats = stats.get(stat.codecId);
          if (codecStats) {
            printToLog("Codec: " + codecStats.mimeType);
          }
        }
        
        // Look for inbound video streams
        if (stat.type === 'inbound-rtp' && stat.kind === 'video') {
          console.log('Inbound video codec:', stat.codecId);
          
          const codecStats = stats.get(stat.codecId);
          if (codecStats) {
            printToLog("Codec: " + codecStats.mimeType);
          }
        }
      }
    }

    function resetPeerConnection() {
      elMessageLog.innerHTML = ''

      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }

      peerConnection = new RTCPeerConnection();

      peerConnection.oniceconnectionstatechange = () => {
        printToLog(peerConnection.iceConnectionState);

        if (peerConnection.iceConnectionState == "connected") {
          getVideoCodec(peerConnection);
        }
      }
    }

    window.doWHEP = () => {
      resetPeerConnection();

      peerConnection.addTransceiver('video', { direction: 'recvonly' })
      peerConnection.addTransceiver('audio', { direction: 'recvonly' })

      peerConnection.ontrack = function (event) {
        document.getElementById('videoPlayer').srcObject = event.streams[0]
      }

      peerConnection.createOffer().then(offer => {
        peerConnection.setLocalDescription(offer)

        fetch(`/whep`, {
          method: 'POST',
          body: offer.sdp,
          headers: {
            'Authorization': 'Bearer none',
            'Content-Type': 'application/sdp'
          }
        }).then(r => r.text())
          .then(answer => {
            peerConnection.setRemoteDescription({
              sdp: answer,
              type: 'answer'
            })
          })
      })
    }

    window.doWHIP = () => {
      resetPeerConnection();

      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
          document.getElementById('videoPlayer').srcObject = stream
          stream.getTracks().forEach(track => peerConnection.addTrack(track, stream))

          peerConnection.createOffer().then(offer => {
            peerConnection.setLocalDescription(offer)

            fetch(`/whip`, {
              method: 'POST',
              body: offer.sdp,
              headers: {
                'Authorization': 'Bearer none',
                'Content-Type': 'application/sdp'
              }
            }).then(r => r.text())
              .then(answer => {
                peerConnection.setRemoteDescription({
                  sdp: answer,
                  type: 'answer'
                })
              })
          })
      })
    }
  </script>
</html>
